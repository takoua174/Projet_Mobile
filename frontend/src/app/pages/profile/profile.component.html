<app-navbar></app-navbar>

<div class="profile-container">
  @if (loading() && !user()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading profile...</p>
    </div>
  } @else {
    <div class="content-wrapper">
      <!-- Header Section -->
      <div class="profile-header">
        <h1 class="page-title">
          <span class="gradient-text">My Profile</span>
        </h1>
        <p class="page-subtitle">Manage your account settings and preferences</p>
      </div>

      <!-- Success/Error Messages -->
      @if (success()) {
        <div class="alert alert-success">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <span>{{ success() }}</span>
        </div>
      }

      @if (error()) {
        <div class="alert alert-error">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"
            />
          </svg>
          <span>{{ error() }}</span>
        </div>
      }

      <div class="profile-grid">
        <!-- Profile Information Card -->
        <div class="profile-card">
          <div class="card-header">
            <h2>Profile Information</h2>
          </div>

          <div class="profile-picture-section">
            <div class="avatar-container">
              @if (profileForm.get('profilePicture')?.value) {
                <img
                  [src]="profileForm.get('profilePicture')?.value"
                  alt="Profile"
                  title="Profile Picture"
                  class="profile-avatar"
                />
              } @else {
                <div class="profile-avatar-placeholder">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"
                    />
                  </svg>
                </div>
              }
            </div>
            <div class="upload-section">
              <label for="profilePicture" class="upload-button">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
                  />
                </svg>
                Upload Photo
              </label>
              <input
                type="file"
                id="profilePicture"
                accept="image/*"
                (change)="onFileSelected($event)"
                class="file-input"
              />
              <p class="upload-hint">JPG, PNG or GIF (Max. 3MB)</p>
            </div>
          </div>

          <form [formGroup]="profileForm" (ngSubmit)="onSubmitProfile()" class="profile-form">
            <div class="form-group">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                id="email"
                [value]="user()?.email"
                disabled
                class="form-input disabled"
              />
              <p class="form-hint">Email cannot be changed</p>
            </div>

            <div class="form-group">
              <label for="username" class="form-label">Username</label>
              <input
                id="username"
                type="text"
                formControlName="username"
                class="form-input"
                [class.error]="username?.invalid && username?.touched"
                placeholder="Enter your username"
              />
              @if (username?.invalid && username?.touched) {
                <div class="error-message">
                  @if (username?.errors?.['required']) {
                    <span>Username is required</span>
                  }
                  @if (username?.errors?.['minlength']) {
                    <span>Username must be at least 3 characters</span>
                  }
                  @if (username?.errors?.['maxlength']) {
                    <span>Username must not exceed 20 characters</span>
                  }
                  @if (username?.errors?.['userNameTaken']) {
                    <span>Username is already taken</span>
                  }
                </div>
              }
            </div>

            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="loading() || profileForm.invalid"
            >
              @if (loading()) {
                <span class="btn-spinner"></span>
                Updating...
              } @else {
                Save Changes
              }
            </button>
          </form>
        </div>

        <!-- Password Section -->
        <div class="profile-card">
          <div class="card-header">
            <h2>Password & Security</h2>
          </div>

          <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()" class="profile-form">
            <div class="form-group">
              <label for="currentPassword" class="form-label">Current Password</label>
              <input
                id="currentPassword"
                type="password"
                formControlName="currentPassword"
                class="form-input"
                [class.error]="currentPassword?.invalid && currentPassword?.touched"
                placeholder="Enter current password"
              />
              @if (currentPassword?.invalid && currentPassword?.touched) {
                <div class="error-message">
                  <span>Current password is required</span>
                </div>
              }
            </div>

            <div class="form-group">
              <label for="newPassword" class="form-label">New Password</label>
              <input
                id="newPassword"
                type="password"
                formControlName="newPassword"
                class="form-input"
                [class.error]="newPassword?.invalid && newPassword?.touched"
                placeholder="Enter new password"
              />
              @if (newPassword?.invalid && newPassword?.touched) {
                <div class="error-message">
                  @if (newPassword?.errors?.['required']) {
                    <span>New password is required</span>
                  }
                  @if (newPassword?.errors?.['minlength']) {
                    <span>Password must be at least 6 characters</span>
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="confirmPassword" class="form-label">Confirm New Password</label>
              <input
                id="confirmPassword"
                type="password"
                formControlName="confirmPassword"
                class="form-input"
                [class.error]="confirmPassword?.invalid && confirmPassword?.touched"
                placeholder="Confirm new password"
              />
              @if (passwordForm.errors?.['passwordMismatch'] && confirmPassword?.touched) {
                <div class="error-message">
                  <span>Passwords do not match</span>
                </div>
              }
            </div>

            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="loading() || passwordForm.invalid"
            >
              @if (loading()) {
                <span class="btn-spinner"></span>
                Updating...
              } @else {
                Update Password
              }
            </button>
          </form>
        </div>
      </div>

      <!-- Favorites Section -->
      <div class="favorites-section">
        <h2 class="section-title">
          <span class="gradient-text">My Favorites</span>
        </h2>

        @if (loadingFavorites()) {
          <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading favorites...</p>
          </div>
        } @else {
          <!-- Favorite Movies -->
          @if (favoriteMovies().length > 0) {
            <div class="favorites-category">
              <h3 class="category-title">Movies</h3>
              <div class="favorites-grid">
                @for (movie of favoriteMovies(); track movie.id) {
                  <div class="favorite-card" (click)="navigateToContent(movie, 'movie')">
                    <div class="favorite-image-container">
                      <img
                        [src]="'https://image.tmdb.org/t/p/w500' + movie.poster_path"
                        [alt]="movie.title"
                        [title]="movie.title"
                        class="favorite-image"
                      />
                      <button
                        type="button"
                        class="remove-favorite"
                        (click)="removeFavorite(movie.id, 'movie'); $event.stopPropagation()"
                        title="Remove from favorites"
                        aria-label="Remove from favorites"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 24 24"
                          fill="currentColor"
                        >
                          <path
                            d="M6.225 4.811a1 1 0 00-1.414 1.414L10.586 12 4.81 17.775a1 1 0 101.414 1.414L12 13.414l5.775 5.775a1 1 0 001.414-1.414L13.414 12l5.775-5.775a1 1 0 00-1.414-1.414L12 10.586 6.225 4.81z"
                          />
                        </svg>
                      </button>
                    </div>
                    <div class="favorite-info">
                      <h4 class="favorite-title">{{ movie.title }}</h4>
                      <p class="favorite-year">{{ movie.release_date?.substring(0, 4) }}</p>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Favorite TV Shows -->
          @if (favoriteTvShows().length > 0) {
            <div class="favorites-category">
              <h3 class="category-title">TV Shows</h3>
              <div class="favorites-grid">
                @for (show of favoriteTvShows(); track show.id) {
                  <div class="favorite-card" (click)="navigateToContent(show, 'tv')">
                    <div class="favorite-image-container">
                      <img
                        [src]="'https://image.tmdb.org/t/p/w500' + show.poster_path"
                        [alt]="show.name"
                        [title]="show.name"
                        class="favorite-image"
                      />
                      <button
                        type="button"
                        class="remove-favorite"
                        (click)="removeFavorite(show.id, 'tv'); $event.stopPropagation()"
                        title="Remove from favorites"
                        aria-label="Remove from favorites"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 24 24"
                          fill="currentColor"
                        >
                          <path
                            d="M6.225 4.811a1 1 0 00-1.414 1.414L10.586 12 4.81 17.775a1 1 0 101.414 1.414L12 13.414l5.775 5.775a1 1 0 001.414-1.414L13.414 12l5.775-5.775a1 1 0 00-1.414-1.414L12 10.586 6.225 4.81z"
                          />
                        </svg>
                      </button>
                    </div>
                    <div class="favorite-info">
                      <h4 class="favorite-title">{{ show.name }}</h4>
                      <p class="favorite-year">{{ show.first_air_date?.substring(0, 4) }}</p>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          @if (favoriteMovies().length === 0 && favoriteTvShows().length === 0) {
            <div class="no-favorites">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"
                />
              </svg>
              <p>No favorites yet</p>
              <p class="no-favorites-hint">Start adding movies and TV shows to your favorites!</p>
            </div>
          }
        }
      </div>
    </div>
  }
</div>
